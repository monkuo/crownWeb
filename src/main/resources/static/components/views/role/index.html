<div class="layui-card">
    <div class="layui-card-header">
        <h2 class="header-title">角色管理</h2>
        <span class="layui-breadcrumb pull-right">
          <a href="#!console">首頁</a>
          <a><cite>角色管理</cite></a>
        </span>
    </div>
    <div class="layui-card-body">
        <!-- 搜尋條件 -->
        <div class="layui-form toolbar">
            <form id="searchForm" onsubmit="return false;">
                角色名：<input name="roleName" class="layui-input search-input" type="text" placeholder="輸入角色名"/>&emsp;
                <button id="role-btn-search" class="layui-btn icon-btn"><i class="layui-icon">&#xe615;</i>搜尋</button>
            </form>
        </div>
        <!-- 表格頂部操作列 -->
        <script type="text/html" id="role-toolbar">
            <div class="layui-btn-container">
                {{# if({{addShow}} == true){ }}
                <button class="layui-btn layui-btn-normal layui-btn-sm" lay-event="add"><i
                        class="layui-icon">&#xe654;</i>新增
                </button>
                {{# } }}
            </div>
        </script>
        <!-- 資料表格 -->
        <table class="layui-table" id="role-table" lay-filter="role-table"></table>
    </div>
</div>

<!-- 表單彈窗 -->
<script type="text/html" id="role-model">
    <form id="role-form" lay-filter="role-form" class="layui-form model-form">
        <input name="id" type="hidden"/>
        <div class="layui-form-item">
            <label class="layui-form-label">角色名</label>
            <div class="layui-input-block">
                <input name="roleName" placeholder="請輸入角色名" type="text" class="layui-input" maxlength="20"
                       lay-verify="required"/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">備註</label>
            <div class="layui-input-block">
                <textarea name="remark" placeholder="請輸入內容" class="layui-textarea" maxlength="200"></textarea>
            </div>
        </div>
        <div class="layui-form-item model-form-footer">
            <button class="layui-btn layui-btn-primary close" type="button">取消</button>
            <button class="layui-btn" lay-filter="role-form-submit" lay-submit>儲存</button>
        </div>
    </form>
</script>

<!-- 表單tree -->
<script type="text/html" id="menu-tree">
    <form id="tree-form" lay-filter="tree-form" class="layui-form model-form">
        <input name="roleId" type="hidden"/>
        <div class="content_wrap" style="padding:20px 70px 100px;height:200px;overflow-y: auto">
            <div>
                <ul id="menuTreeData" class="ztree"></ul>
            </div>
        </div>
        <div class="layui-form-item model-form-footer" style="padding:10px 30px;">
            <button class="layui-btn layui-btn-primary layui-btn-sm close" type="button">取消</button>
            <button class="layui-btn layui-btn-sm" lay-filter="tree-form-submit" lay-submit>儲存</button>
        </div>
    </form>
</script>

<!-- 表格操作列 -->
<script type="text/html" id="role-table-bar">
    {{#  if({{permShow}} == true){ }}
    <a class="layui-btn layui-btn-warm layui-btn-xs" lay-event="resource">選單授權</a>
    {{#  } }}
    {{#  if({{editShow}} == true){ }}
    <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="edit">修改</a>
    {{#  } }}
    {{#  if({{deleteShow}} == true){ }}
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">刪除</a>
    {{#  } }}
</script>

<script>
    var setting = {
        view: {
            addHoverDom: addHoverDom,
            removeHoverDom: removeHoverDom,
            selectedMulti: false
        },
        check: {
            enable: true
        },
        data: {
            keep: {
                parent: true
            },
            simpleData: {
                enable: true,
                idKey: "id",
                pIdKey: "parentId"
            },
            key: {
                name: "menuName"
            },
            check: {
                enable: true, // 顯示多選框按鈕
                chkStyle: "checkbox", // 新增生效
                chkboxType: {"Y": "", "N": ""} //Y:勾選（參數：p:影響父節點），N：不勾（參數s：影響子節點）[p 和 s 為參數]
            }
        },
        edit: {
            enable: true
        }

    };

    var newCount = 1;

    function onAsyncSuccess() {
        //獲得樹形圖物件
        var zTree = $.fn.zTree.getZTreeObj("menuTreeData");
        //獲取根節點個數,getNodes獲取的是根節點的集合
        var nodeList = zTree.getNodes();
        for (var i = 0; i < nodeList.length; i++) {
            zTree.expandNode(nodeList[i], true, false, false, false);
        }
    }

    function addHoverDom(treeId, treeNode) {
        var sObj = $("#" + treeNode.tId + "_span");
        if (treeNode.editNameFlag || $("#addBtn_" + treeNode.tId).length > 0) return;
        var addStr = "<span class='button add' id='addBtn_" + treeNode.tId
            + "' title='add node' onfocus='this.blur();'></span>";
        sObj.after(addStr);
        var btn = $("#addBtn_" + treeNode.tId);
        if (btn) btn.bind("click", function () {
            var zTree = $.fn.zTree.getZTreeObj("menuTreeData");
            zTree.addNodes(treeNode, {id: (100 + newCount), pId: treeNode.id, name: "new node" + (newCount++)});
            return false;
        });
    };

    function removeHoverDom(treeId, treeNode) {
        $("#addBtn_" + treeNode.tId).unbind().remove();
    };
    layui.use(['form', 'table', 'config', 'crown'], function () {
        var form = layui.form;
        var table = layui.table;
        var config = layui.config;
        var layer = layui.layer;
        var crown = layui.crown;
        var $ = layui.jquery;

        $('#role-toolbar').vm({
            addShow: crown.hasPerm("sys:role:add")
        });
        $('#role-table-bar').vm({
            editShow: crown.hasPerm("sys:role:edit"),
            permShow: crown.hasPerm("sys:role:perm"),
            deleteShow: crown.hasPerm("sys:role:delete")
        });
        //渲染表格
        var roleTable = table.render({
            elem: '#role-table',
            toolbar: '#role-toolbar',
            url: config.serverUrl + '/roles',
            request: config.request,
            parseData: config.parseData,
            response: config.response,
            headers: {Authorization: config.getToken()},
            page: true,
            cols: [[
                {type: 'numbers'},
                {field: 'id', align: 'center', width: 60, sort: true, title: 'ID'},
                {field: 'roleName', align: 'center', sort: true, title: '角色名'},
                {field: 'remark', align: 'center', sort: true, title: '備註'},
                {field: 'createTime', align: 'center', sort: true, title: '建立時間'},
                {field: 'updateTime', align: 'center', sort: true, title: '修改時間'},
                {align: 'center', toolbar: '#role-table-bar', title: '操作', width: 200}
            ]]
        });

        // 新增
        table.on('toolbar(role-table)', function (obj) {
            if (obj.event === 'add') {
                showEditModel();
            }
        });

        // 表單提交事件
        form.on('submit(role-form-submit)', function (data) {
            layer.load(2);
            if (data.field.id) {
                crown.put('/roles/' + data.field.id, {data: data.field}, function () {
                    layer.closeAll('loading');
                    layer.msg('修改成功', {icon: 1});
                    roleTable.reload('role-table');
                    layer.closeAll('page');
                });
            } else {
                crown.post('/roles', {data:data.field}, function () {
                    layer.closeAll('loading');
                    layer.msg('新增成功', {icon: 1});
                    roleTable.reload('role-table');
                    layer.closeAll('page');
                });
            }
            return false;
        });

        // 表單提交事件
        form.on('submit(tree-form-submit)', function (data) {
            layer.load(2);
            var zTree = $.fn.zTree.getZTreeObj("menuTreeData");
            var checked = zTree.getCheckedNodes();
            var menuIds = [];
            for (var i = 0; i < checked.length; i++) {
                menuIds.push(checked[i].id);
            }
            if (menuIds.length == 0) {
                layer.msg('請選擇關聯選單', {icon: 5});
                layer.closeAll('page');
                return false;
            }
            crown.put('/roles/' + data.field.roleId + '/menus', {data: menuIds}, function () {
                layer.closeAll('loading');
                layer.msg('關聯成功', {icon: 1});
                roleTable.reload('role-table');
                layer.closeAll('page');
            });
            return false;
        });

        // 工具條點選事件
        table.on('tool(role-table)', function (obj) {
            var data = obj.data;
            if (obj.event === 'edit') { //修改
                showEditModel(data);
            } else if (obj.event === 'del') { //刪除
                doDelete(obj);
            } else if (obj.event === 'resource') {
                showMenuTree(data);
            }
        });

        //顯示選單樹
        var showMenuTree = function (data) {
            var menuIds = data.menuIds;
            layer.open({
                type: 1,
                title: '選單關聯',
                area: '450px',
                offset: '120px',
                content: $('#menu-tree').html(),
                success: function () {
                    $('#tree-form')[0].reset();
                    form.val("tree-form", {
                        "roleId": data.id
                    });
                    //樹形選單
                    crown.get('/menus', {}, function (data) {
                        var result = data.result;
                        //定義一陣列
                        var zNodes = [];
                        for (var i = 0; i < result.length; i++) {
                            var zNode = {};
                            zNode.id = result[i].id;
                            zNode.parentId = result[i].parentId;
                            zNode.menuName = result[i].menuName;
                            zNode.isParent = result[i].menuType == 3 ? false : true;
                            zNodes.push(zNode);
                        }
                        var zTree = $.fn.zTree.init($("#menuTreeData"), setting, zNodes);
                        if (menuIds) {
                            for (var j = 0; j < menuIds.length; j++) {
                                var node = zTree.getNodeByParam("id", menuIds[j]);
                                zTree.checkNode(node, true, false);
                            }
                        }
                        onAsyncSuccess();
                        layer.closeAll('loading');
                    });
                    $('#tree-form .close').click(function () {
                        layer.closeAll('page');
                    });
                }
            });
        };

        // 顯示編輯彈窗
        var showEditModel = function (data) {
            layer.open({
                type: 1,
                title: data ? '修改角色' : '新增角色',
                area: '450px',
                offset: '120px',
                content: $('#role-model').html(),
                success: function () {
                    $('#role-form')[0].reset();
                    if (data) {
                        form.val('role-form', data);
                    }
                    $('#role-form .close').click(function () {
                        layer.closeAll('page');
                    });
                }
            });
        };
        // 刪除
        var doDelete = function (obj) {
            layer.confirm('確定要刪除嗎？', function (i) {
                layer.close(i);
                layer.load(2);
                crown.delete('/roles/' + obj.data.id, {}, function () {
                    layer.closeAll('loading');
                    layer.msg('刪除成功', {icon: 1});
                    obj.del();
                });
            });
        };

        // 搜尋按鈕點選事件
        $('#role-btn-search').click(function () {
            roleTable.reload({where: crown.getSearchForm()});
        });
    });

</script>