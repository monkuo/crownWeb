<form id="menu-form" lay-filter="menu-form" class="layui-form model-form">
    <input name="id" type="hidden"/>
    <div class="layui-form-item">
        <label class="layui-form-label">選單名稱</label>
        <div class="layui-input-block">
            <input name="menuName" placeholder="請輸入選單名稱" type="text" class="layui-input" maxlength="20"
                   lay-verify="required"/>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">許可權別名</label>
        <div class="layui-input-block">
            <input name="alias" placeholder="請輸入許可權別名" type="text" class="layui-input" maxlength="64"/>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">類型</label>
        <div class="layui-input-block">
            <select name="menuType" lay-verify="required" lay-filter="menuType">
                <option value="1" selected="selected">目錄</option>
                <option value="2">選單</option>
                <option value="3">按鈕</option>
            </select>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">選擇圖示</label>
        <div class="layui-input-block">
            <input type="text" id="iconPicker" name="icon" lay-filter="iconPicker" class="layui-input"/>
        </div>
    </div>
    <div class="layui-form-item" id="pathDiv" style="display: none">
        <label class="layui-form-label">選單路徑</label>
        <div class="layui-input-block">
            <input name="path" placeholder="請輸入路徑" type="text" class="layui-input" maxlength="64" lay-verify=""/>
        </div>
    </div>
    <div class="layui-form-item" id="routerDiv" style="display: none">
        <label class="layui-form-label">路由</label>
        <div class="layui-input-block">
            <input name="router" placeholder="請輸入路由地址" type="text" class="layui-input" maxlength="64" lay-verify=""/>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">狀態</label>
        <div class="layui-input-block">
            <input type="radio" name="status" value="0" title="正常" checked="checked">
            <input type="radio" name="status" value="1" title="禁用">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">上級選單</label>
        <div class="layui-input-block">
            <select id="parentId" name="parentId" lay-filter="parentId" lay-verify="required">
                <option value="">請選擇</option>
                <option value="0">首級選單</option>
                <option p-for="parents" p-bind="value:{{id}}">{{name}}</option>
            </select>
        </div>
    </div>
    <div class="layui-form-item" id="resourceIdsDiv" style="display: none">
        <label class="layui-form-label">對應資源</label>
        <div class="layui-input-block">
            <select name="resourceIds" xm-select="resourceIds" xm-select-search="" xm-select-max="5">
            </select>
        </div>
    </div>
    <div class="layui-form-item model-form-footer">
        <button class="layui-btn layui-btn-primary close" type="button">取消</button>
        <button class="layui-btn" lay-filter="menu-form-submit" lay-submit>儲存</button>
    </div>
</form>

<script>
    layui.use(['layer', 'crown', 'form', 'iconPicker', 'formSelects'], function () {
        var layer = layui.layer;
        var crown = layui.crown;
        var form = layui.form;
        var $ = layui.jquery;
        var iconPicker = layui.iconPicker;
        var formSelects = layui.formSelects;
        var menu = crown.getTempData('t_menu');

        crown.get('/resources/resources', {async: false}, function (data) {
            // 渲染多選下拉框
            var resourceSelectData = new Array();
            for (var i = 0; i < data.result.length; i++) {
                resourceSelectData.push({
                    name: data.result[i].resourceName + ':' + data.result[i].perm,
                    value: data.result[i].id
                });
            }
            formSelects.data('resourceIds', 'local', {arr: resourceSelectData});
        });

        // 獲取所有選單
        crown.get('/menus/combos', {}, function (data) {
            $('#parentId').vm({parents: data.result});
            form.render('select');
            // 回顯menu資料
            if (menu) {
                if (menu.menuType == 1) {
                    $("#resourceIdsDiv").hide();
                    $("#pathDiv").hide();
                    $("#routerDiv").hide();
                } else if (menu.menuType == 2) {
                    $("#pathDiv").show();
                    $("#routerDiv").show();
                    $("#resourceIdsDiv").show();
                } else if (menu.menuType == 3) {
                    $("#pathDiv").hide();
                    $("#routerDiv").hide();
                    $("#resourceIdsDiv").show();
                }
                if (menu.resourceIds) {
                    var rds = new Array();
                    for (var i = 0; i < menu.resourceIds.length; i++) {
                        rds.push(menu.resourceIds[i]);
                    }
                    formSelects.value('resourceIds', rds);
                }
                crown.fromVal('menu-form', menu);
                iconPicker.checkIcon('iconPicker', menu.icon);
            } else {
                iconPicker.checkIcon('iconPicker', 'layui-icon-rate-half');
            }
        });
        // 表單提交事件
        form.on('select(menuType)', function (data) {
            if (data.value == 1) {
                $("#resourceIdsDiv").hide();
                $("#pathDiv").hide();
                $("#routerDiv").hide();
            } else if (data.value == 2) {
                $("#pathDiv").show();
                $("#routerDiv").show();
                $("#resourceIdsDiv").show();
            } else if (data.value == 3) {
                $("#pathDiv").hide();
                $("#routerDiv").hide();
                $("#resourceIdsDiv").show();
            }
        });
        // 表單提交事件
        form.on('submit(menu-form-submit)', function (data) {
            //定義一陣列
            var resourceIds = new Array();
            if (data.field.resourceIds) {
                resourceIds = data.field.resourceIds.split(",");
            }
            data.field.resourceIds = resourceIds;
            layer.load(2);
            if (data.field.id) {
                crown.put('/menus/' + data.field.id, {data: data.field}, function () {
                    layer.closeAll('loading');
                    layer.msg('修改成功', {icon: 1});
                    crown.finishPopupCenter();
                });
            } else {
                crown.post('/menus', {data: data.field}, function () {
                    layer.closeAll('loading');
                    layer.msg('新增成功', {icon: 1});
                    crown.finishPopupCenter();
                });
            }
            return false;
        });
        iconPicker.render({
            // 選擇器，推薦使用input
            elem: '#iconPicker',
            // 資料類型：fontClass/unicode，推薦使用fontClass
            type: 'fontClass',
            // 是否開啟搜尋：true/false
            search: true,
            // 是否開啟分頁
            page: true,
            // 每頁顯示數量，預設12
            limit: 12,
            // 點選回撥
            click: function (data) {
                $("#iconPicker").val(data.icon);
            }
        });
        form.render();
    });
</script>